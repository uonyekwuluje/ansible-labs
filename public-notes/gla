---
version: "3.9"

services:
  gitlabci:
    image: gitlab/gitlab-ce:16.4.0-ce.0
    hostname: gitlabci
    container_name: gitlabci
    restart: unless-stopped
    environment:
       GITLAB_OMNIBUS_CONFIG: |
         external_url 'http://localhost'
         nginx['ssl_certificate'] = "/etc/gitlab/ssl/localhost.crt"
         nginx['ssl_certificate_key'] = "/etc/gitlab/ssl/localhost.key"
         nginx['ssl_protocols'] = "TLSv1.2 TLSv1.3"
    ports:
      - 8080:80
      - 8443:443
    volumes: 
      - ./config:/etc/gitlab
      - ./logs:/var/log/gitlab
      - ./data:/var/opt/gitlab
      - ./ssl:/etc/gitlab/ssl
      - ./ssl/rootCA.pem:/usr/local/share/ca-certificates/rootCA.pem 
    networks:
      - gitlab-network 

  gitlab-runner:
    image: gitlab/gitlab-runner:alpine
    container_name: gitlab-runner
    hostname: gitlab-runner    
    restart: always
    depends_on:
      - gitlabci
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./gitlab-runner:/etc/gitlab-runner
      - ./ssl/rootCA.pem:/usr/local/share/ca-certificates/rootCA.pem	
    networks:
      - gitlab-network


networks:
  gitlab-network:
    driver: bridge

